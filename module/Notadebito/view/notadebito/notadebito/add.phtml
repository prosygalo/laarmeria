<?php
$title='Agregar Nota de Débito';
$this->headTitle($title);
$Fecha_Emision = $form->get('Fecha_Emision');
$Fecha_Emision_Comprobante = $form->get('Fecha_Emision_Comprobante');
$Consecutivo_Actual_Establ = $form->get('Consecutivo_Actual_Establ');
$Consecutivo_Actual_Punto = $form->get('Consecutivo_Actual_Punto');
$Consecutivo_Actual_Tipo = $form->get('Consecutivo_Actual_Tipo');
$Consecutivo_Actual_Correlativo = $form->get('Consecutivo_Actual_Correlativo');
$Sucursal = $form->get('Sucursal');
$Sucursal->setAttribute('readonly', 'readonly');
$Autorizacion_Sar = $form->get('Autorizacion_Sar');
$Autorizacion_Sar->setAttribute('readonly', 'readonly');
$Cliente = $form->get('Cliente');
$Rtn_Dni = $form->get('Rtn_Dni');
$No_Correlativo = $form->get('No_Correlativo');
$Cai_Comprobante = $form->get('Cai_Comprobante');
$Motivo = $form->get('Motivo');
$Usuario = $form->get('Usuario')->setValue($this->identity()['Cod_Usuario']);
$productos = $form->get('productos');
$Isv=$form->get('Isv');
$Exonerado=$form->get('Exonerado');
$Exento=$form->get('Exento');
$Gravado=$form->get('Gravado');
$Total=$form->get('Total');
$Cancelar = $form->get('Cancelar');
$Agregar = $form->get('Agregar');
$submit = $form->get('submit');
$form->prepare();
?>
<section>
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h4 class="text-center"><i class="fa fa-file fa-md" aria-hidden="true"></i><?= $this->escapeHtml($title) ?></h4>
            </div>
            <div class="card-body">
                <?= $this->form()->openTag($form)?>
                <strong>Documento Fiscal No.</strong>
                <div class="row">
                      <div class="col-md-1">
                          <div class="form-group">
                            <?= $this->formLabel($Consecutivo_Actual_Establ) ?>
                            <?= $this->formElement($Consecutivo_Actual_Establ) ?>
                            <?= $this->formElementErrors()->render($Consecutivo_Actual_Establ, ['class' => 'help-inline  text-danger']) ?>
                          </div>
                      </div>
                      <div class="col-md-1">
                          <div class="form-group">
                            <?= $this->formLabel($Consecutivo_Actual_Punto) ?>
                            <?= $this->formElement($Consecutivo_Actual_Punto) ?>
                            <?= $this->formElementErrors()->render($Consecutivo_Actual_Punto, ['class' => 'help-inline  text-danger']) ?>
                          </div>
                      </div>
                      <div class="col-md-1">
                          <div class="form-group">
                            <?= $this->formLabel($Consecutivo_Actual_Tipo) ?>
                            <?= $this->formElement($Consecutivo_Actual_Tipo) ?>
                            <?= $this->formElementErrors()->render($Consecutivo_Actual_Tipo, ['class' => 'help-inline  text-danger']) ?>
                          </div>
                      </div>
                      <div class="col-md-2">
                          <div class="form-group">
                            <?= $this->formLabel($Consecutivo_Actual_Correlativo) ?>
                            <?= $this->formElement($Consecutivo_Actual_Correlativo) ?>
                            <?= $this->formElementErrors()->render($Consecutivo_Actual_Correlativo, ['class' => 'help-inline  text-danger']) ?>
                          </div>
                      </div>
                </div><br>
                 <strong>Información de cliente</strong>
                <div class="row" style="background-color:#F5F5F5">
                   <div class="col-md-5">
                        <div class="form-group">
                            <?= $this->formLabel($Rtn_Dni) ?>
                            <?= $this->formElement($Rtn_Dni) ?>
                            <?= $this->formElementErrors()->render($Rtn_Dni, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                    <div class="col-md-7">
                        <div class="form-group">
                            <?= $this->formLabel($Cliente) ?>
                            <?= $this->formElement($Cliente) ?>
                            <?= $this->formElementErrors()->render($Cliente, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                </div><br>
                <strong>Datos adicionales</strong>
                <div class="row" style="background-color:#F5F5F5">
                    <div class="col-md-5">
                       <div class="form-group">
                            <?= $this->formLabel($Cai_Comprobante) ?>
                            <?= $this->formElement($Cai_Comprobante) ?>
                            <?= $this->formElementErrors()->render($Cai_Comprobante, ['class' => 'help-inline  text-danger']) ?>
                           <span class="text-info">Ejemplo: formato "6E7C83-81B02E-9E47B7-BB1747-32EAAE-47"</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                         <div class="form-group">
                            <?= $this->formLabel($Fecha_Emision_Comprobante) ?>
                            <?= $this->formElement($Fecha_Emision_Comprobante) ?>
                            <?= $this->formElementErrors()->render($Fecha_Emision_Comprobante, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <?= $this->formLabel($No_Correlativo) ?>
                            <?= $this->formElement($No_Correlativo) ?>
                            <?= $this->formElementErrors()->render($No_Correlativo, ['class' => 'help-inline  text-danger']) ?>
                           <span class="text-info">Ejemplo: formato "000-000-00-00000000"</span>
                        </div>
                    </div>
                </div>
                <div class="row"  style="background-color:#F5F5F5">
                    <div class="col-md-2">
                        <div class="form-group">
                            <?= $this->formLabel($Usuario) ?>
                            <?= $this->formElement($Usuario) ?>
                            <?= $this->formElementErrors()->render($Usuario, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <?= $this->formLabel($Sucursal) ?>
                            <?= $this->formElement($Sucursal) ?>
                            <?= $this->formElementErrors()->render($Sucursal, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <?= $this->formLabel($Autorizacion_Sar) ?>
                            <?= $this->formElement($Autorizacion_Sar) ?>
                            <?= $this->formElementErrors()->render($Autorizacion_Sar, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <?= $this->formLabel($Fecha_Emision) ?>
                            <?= $this->formElement($Fecha_Emision) ?>
                            <?= $this->formElementErrors()->render($Fecha_Emision, ['class' => 'help-inline  text-danger']) ?>
                        </div>
                    </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                          <div class="form-group">
                            <?= $this->formLabel($Motivo) ?>
                            <?= $this->formElement($Motivo) ?>
                            <?= $this->formElementErrors()->render($Motivo, ['class' => 'help-inline  text-danger']) ?>
                          </div>
                    </div>
                </div>
                <div class="row">         
                    <div class="col-md-12">
                        <table id="TablaPro" class="table">
                            <thead>
                                <tr class="text-center">
                                    <th></th>
                                    <th>Código</th>
                                    <th>Descripci&oacute;n</th>
                                    <th>Precio unit.</th>
                                    <th>Cant.</th>
                                    <th rowspan="2">Stock Disponible</th>
                                    <th>Subtotal</th>
                                </tr>
                            </thead>
                            <tbody id="ProSelected">
                              <!--Ingreso al tbody-->
                                <tr>
                    
                                </tr>
                            </tbody>
                            <tfoot  class="text-right">
                              <tr>
                                <td></td>
                                <td>Exonerado</td>
                                <td>Exento</td>
                                <td>Gravado</td>
                                <td>15% I.S.V.</td>
                                <td>Total</td>
                                <td></td>
                              </tr>
                              <tr>
                                <td></td>
                                 <td><span id="exonerado">0</span>
                                    <?= $this->formHidden($form->get('Exonerado'))?>
                                    <?= $this->formElementErrors()->render($Exonerado, ['class' => 'help-inline  text-danger']) ?>
                                </td>
                                <td><span id="exento">0</span>
                                    <?= $this->formHidden($form->get('Exento'))?>
                                     <?= $this->formElementErrors()->render($Exento, ['class' => 'help-inline  text-danger']) ?>
                                </td>
                                 <td><span id="gravado">0</span>
                                    <?= $this->formHidden($form->get('Gravado'))?>
                                    <?= $this->formElementErrors()->render($Gravado, ['class' => 'help-inline  text-danger']) ?>
                                </td>
                               
                                <td><span id="isv">0</span>
                                    <?= $this->formHidden($form->get('Isv'))?>
                                     <?= $this->formElementErrors()->render($Isv, ['class' => 'help-inline  text-danger']) ?>
                                </td>
                                <td><span id="total">0</span>
                                    <?= $this->formHidden($form->get('Total'))?>
                                     <?= $this->formElementErrors()->render($Total, ['class' => 'help-inline  text-danger']) ?>
                                </td>
                                <td></td>
                              </tr>
                              <tr>
                                <td colspan="7"><span id="error"></span></td>
                              </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                        <!-- cancelar-->
                        <?= $this->formButton($Agregar)?>
                            <span id="limit" class="help-inline  text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <!--cancelar-->
                        <div class="form-group">
                        <?= $this->formButton($Cancelar)?>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                        <!-- guardado-->
                        <?php
                            echo  $this->formSubmit($submit);
                            echo  $this->formHidden($form->get('Cod_Nota'));
                        ?>
                        </div>
                    </div>
                </div>
            </div>
            <?=  $this->form()->closeTag()?> 
        </div>
    </div>
</section>
<!-- Large modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
                    <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                   <h4 class="modal-title"><i class="fa fa-shopping-cart"></i>Agregar artículos a la lista</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                       <span aria-hidden="true">&times;</span>
                    </button>            
                </div>
                <div class="modal-body">
                    <div class="form-group">
                      <?= $this->formElement($productos) ?>
                    </div>
                </div>
                <div class="modal-footer">
                     <!--Uso la funcion onclick para llamar a la funcion en javascript-->
                    <button type="button" id="blo" onclick="agregarProducto()" class="btn btn-primary btn-danger active btn-lg" data-dismiss="modal">Agregar</button>
                </div>
            </div>
        </div>
    </div>
<script type="text/javascript">
  $( document ).ready(function(){           
    $('#Fecha_Emision_Comprobante').datepicker({
      iconsLibrary: 'fontawesome',
      footer: true,
      modal: true,
      format: 'yyyy-mm-dd',
      //locale: 'es-es'
      });
     $('#Rtn_Dni').focus();

  });
  function cancelar(){
     window.location.href="<?= $this->url('home')?>";
   }
   $(function(){
       $('#Rtn_Dni').change(function(){
         var Rtn_Dni = $(this).val();
         if(Rtn_Dni){
            $.ajax({
             type: "GET",
             url: "/notadebito/cliente/" + $(this).val(),
             async: true,
             dataType: "json",
             beforeSend: function(x) {
                if(x && x.overrideMimeType) {
                   x.overrideMimeType("application/j-son;charset=UTF-8");
                }
             },
             success: function(data){
                var Nom_Cli = '';
                   for (var i = 0; i < data.length; i++) {
                    Nom_Cli += '<option value="' + data[i].Cod_Cliente + '">' + data[i].Nombres_Cliente +' '+ data[i].Apellidos_Cliente + '</option>';
                   }
                   $('#Cliente').html(Nom_Cli);
            }
        });
      }else{
           $('#Cliente').html('<option value>Seleccione RTN</option>');
      }});
    });
  function RefrescaProducto(){
    var ip = [];
    var i = 0;
    $('.contadorfilas').each(function(index, element){
      i++;
      ip.push({
          id_pro: $(this).val()
        });
      });
    if(i != ''){
      $('#submit').removeAttr('disabled', 'disabled');
    }else{
      $('#submit').attr('disabled', 'disabled');
    }
    if(i == 12){
      $('.blo').attr('disabled', 'disabled');
    }
    if(i <  12){
      $('.blo').removeAttr('disabled', 'disabled');
       
    }
 }

  function agregarProducto(){
         var Cod = $('#pro_id').find(':selected').val();
         $.ajax({
             type: "GET",
             url: "/notadebito/producto/" + $('#pro_id').find(':selected').val(),
             dataType: "json",
             beforeSend: function(x) {
                if(x && x.overrideMimeType) {
                   x.overrideMimeType("application/j-son;charset=UTF-8");
                }
             },
             success: function(prod){
              var id = '';
              var Proc = '';
              var Des = '';
              var Pre = '';
              var Exis='';
              
                  for (var i = 0; i  < prod.length; i++) {
                    id +=  prod[i].Cod_Producto;
                    Proc +=  prod[i].Nombre_Producto;
                    Des +=  prod[i].Descripcion;
                    Pre +=  prod[i].Precio;
                    Exis += prod[i].Cantidad;
                   }
                    if(checkId(id)){

                     swal({ 
                       type: "warning",
                      title: 'Lo sentimos...',
                      text: '¡El código de este artículo ya ha sido agregado!',
                       },
                     );
                    }else{
                     var newtr = '<tr class="item"  id="'+id+'">';//Obtengo en el tr el Id
                     newtr = newtr + '<td class="contadorfilas"><input  type="hidden" name="Cod_Detalle[]"></td><td><input type="text" name="Cod_Producto[]" id="Cod_Producto[]" class="form-control" value="'+id+'" required/></td><td><input class="form-control Descripcion"  type="text" name="Descripcion[]" id="Descripcion[]"  value="'+Proc+Des+'" readonly /></td><td><input class="form-control text-right Precio" maxlength="8"  type="text" name="Precio[]" id="Precio[]" value="'+Pre+'" onChange="Calcular(this);" onkeypress="return filterFloat(event,this);" required readonly /></td><td><input class="form-control text-center"  type="number" min="0"  max="'+Exis+'"  onkeypress="return event.target.value.length < 2" id="Cantidad[]" name="Cantidad[]"  placeholder="0"  onChange="Calcular(this);" required/></td><td class="text-center"><input class="btn btn-primary Existencia"  type="button"  id="Existencia[]" name="Existencia[]" value="'+Exis+'" onChange="Calcular(this);" /></td><td><input class="form-control text-right Subtotal" type="text" id="Subtotal[]"  value ="0"  onChange="Calcular(this);" onFocus="this.blur()" readonly/></td></tr>';
                      
           
                       $('#ProSelected').append(newtr); //Agrego el Producto al tbody de la Tabla con el id=ProSelected 
                         
                         RefrescaProducto();
                      
                   }
                 }
             
               });
                
                $('.contadorfilas').off().change(function(e){
                  
                RefrescaProducto();
            
              });
                
}
function checkId(id){
                    let ids = document.querySelectorAll('#TablaPro tr[id]');
                  return [].filter.call(ids, tr => tr.id=== id).length === 1;
}

          
function Calcular(ele){

            var cantidad = 0,  precio = 0, existencia = 0, max=0, subtotal = 0, importisv=0, importgra=0, importexe=0;
            var tr = ele.parentNode.parentNode;
            var nodes = tr.childNodes;
        
            for (var x = 0; x < nodes.length; x++) {
                
                if (nodes[x].firstChild.id == 'Cantidad[]'){
                    cantidad = parseFloat(nodes[x].firstChild.value);
                    max = parseFloat(nodes[x].firstChild.max);
                }

                if (nodes[x].firstChild.id == 'Precio[]'){
                    precio = parseFloat(nodes[x].firstChild.value);
                }

                if (nodes[x].firstChild.id == 'Existencia[]'){
                    existencia = parseFloat(nodes[x].firstChild.value);
                }
                if(cantidad > max){
                   $('#submit').attr('disabled', 'disabled');
                   $('#error').html('<center><div class="alert alert-danger">*Stock no Disponible</div></center>');
                }
                if(cantidad <= max){
                   $('#submit').removeAttr('disabled', 'disabled');
                   $('#error').html('');
                }
                if(isNaN(precio)){
                      subtotal = 0;
                      nodes[x].firstChild.value = subtotal;
                }

               if (nodes[x].firstChild.id == 'Subtotal[]'){
                    anterior = nodes[x].firstChild.value;
                    subtotal = parseFloat((precio*cantidad),10);
                    nodes[x].firstChild.value = subtotal;

                }    
                  
          }
                     
            var total = document.getElementById("total");
            total.innerHTML = (parseFloat(total.innerHTML) + subtotal - anterior).toFixed(2);
            var to = document.querySelector('#total').innerText;
            var input_to = document.querySelector('input[name="Total"]');
            input_to.value = to;
             
            var isv = document.getElementById("isv");
            isv.innerHTML = (parseFloat(isv.innerHTML) +  (((subtotal - anterior) / 1.15) * 0.15)).toFixed(2);
            var is = document.querySelector('#isv').innerText;
            var input_is = document.querySelector('input[name="Isv"]');
            input_is.value = is;
 
            var gravado = document.getElementById("gravado");
            gravado.innerHTML = (parseFloat(gravado.innerHTML) + ((subtotal - anterior) / 1.15)) .toFixed(2);
            var gra = document.querySelector('#gravado').innerText;
            var input_gra = document.querySelector('input[name="Gravado"]');
            input_gra.value = gra;

            var exento = document.getElementById("exento");
            exento.innerHTML = 222.00;
            var exe = document.querySelector('#exento').innerText;
            var input_exe = document.querySelector('input[name="Exento"]');
            input_exe.value = exe;

            var exonerado = document.getElementById("exonerado");
            exonerado.innerHTML = 222.00;
            var exo = document.querySelector('#exonerado').innerText;
            var input_exo = document.querySelector('input[name="Exonerado"]');
            input_exo.value = exo;



}

function filterFloat(evt,input){
    // Backspace = 8, Enter = 13, ‘0′ = 48, ‘9′ = 57, ‘.’ = 46, ‘-’ = 43
    var key = window.Event ? evt.which : evt.keyCode;    
    var chark = String.fromCharCode(key);
    var tempValue = input.value+chark;
    if(key >= 48 && key <= 57){
        if(filter(tempValue)=== false){
            return false;
        }else{       
            return true;
        }
    }else{
          if(key == 8 || key == 13 || key == 46 || key == 0) {            
              return true;              
          }else{
              return false;
          }
    }
}

function filter(__val__){
    var preg = /^([0-9]+\.?[0-9]{0,2})$/; 
    if(preg.test(__val__) === true){
        return true;
    }else{
       return false;
    }
    
}  
function fac(e){
           tecla = (document.all) ? e.keyCode : e.which;
           if (tecla==8){
            return true;
             }
          patron =/^[0-9-]$/;
          tecla_final = String.fromCharCode(tecla);
  
          return patron.test(tecla_final);
}
function ca(e){
           tecla = (document.all) ? e.keyCode : e.which;
           if (tecla == 8){
            return true;
             }
          patron =/^[A-Z0-9-]$/;
          tecla_final = String.fromCharCode(tecla);
          return patron.test(tecla_final);
}
</script>